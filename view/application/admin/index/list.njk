{% extends 'layout/master.njk' %}

{% block content %}
<div id="app-container">
  <!-- 1. Primary Sidebar (Icon Rail) -->
  <nav id="primary-sidebar">
    <div class="primary-nav-items">
      <!-- Home -->
      <a href="{{ url('adminIndexList', { id: rootFolderId }, { query: { view: 'my-drive', layout: layoutMode } }) }}" 
         class="primary-nav-item {% if currentFolderId == rootFolderId and viewMode != 'starred' %}active{% endif %}"
         data-tooltip="Home">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </a>

      <!-- My Drive (Toggles Secondary Panel) -->
      <div class="primary-nav-item {% if viewMode == 'my-drive' and currentFolderId != rootFolderId %}active{% endif %}" 
           id="btn-my-drive"
           data-tooltip="My Drive">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
      </div>

      <!-- Shared with me -->
      <a href="#" class="primary-nav-item" data-tooltip="Shared with me">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      </a>

      <!-- Recent -->
      <a href="#" class="primary-nav-item" data-tooltip="Recent">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </a>

      <!-- Starred -->
      <a href="{{ url('adminIndexList', null, { query: { id: rootFolderId, view: 'starred', layout: layoutMode} }) }}" 
         class="primary-nav-item {% if viewMode == 'starred' %}active{% endif %}"
         data-tooltip="Starred">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
        </svg>
      </a>

      <!-- Trash -->
      <a href="#" class="primary-nav-item" data-tooltip="Trash">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
      </a>
    </div>

    <div class="primary-nav-bottom">
       <!-- Settings -->
       <a href="#" class="primary-nav-item" data-tooltip="Settings">
         <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
           <circle cx="12" cy="12" r="3"></circle>
           <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
         </svg>
       </a>
       
       <!-- User Avatar Placeholder -->
       <div class="primary-nav-item profile-item">
         <div class="user-avatar">M</div>
       </div>
    </div>
  </nav>

  <!-- 2. Secondary Sidebar (Expandable Panel) -->
  <aside id="secondary-sidebar" class="sidebar-panel">
      <div class="panel-header">
        <h5 class="panel-title">My Drive</h5>
        <!-- Optional: Close button or actions -->
      </div>
      
      <!-- New Button Area (Static, No Overflow) -->
      <div class="panel-actions">
          {{ newButton(currentFolderId) | safe }}
      </div>
      
      <div class="panel-content">


         <!-- Folder Tree -->
         <div class="folder-tree-container">
            <ul class="nav flex-column folder-tree-root">
               {% if folderTree and folderTree.length > 0 %}
                {% set treeActiveId = currentFolderId %}
                {% if viewMode == 'starred' %}
                  {% set treeActiveId = null %}
                {% endif %}
                {{ renderFolderTree(folderTree, 0, treeActiveId, viewMode, layoutMode) | safe }}
              {% else %}
                <li class="pl-3 text-muted small">No folders found</li>
              {% endif %}
            </ul>
         </div>
      </div>
      
      <!-- Resize Handle -->
      <div class="resize-handle"></div>
  </aside>

  <!-- 3. Main Content -->
  <main id="main-content" style="padding-left: 16px; padding-right: 016px;">
      <!-- Search Bar Area -->
      <div class="d-flex justify-content-center align-items-center py-3 mb-3 border-bottom search-container">
         <!-- Mobile Toggle -->
         <button id="mobile-sidebar-toggle" class="btn btn-link text-muted d-md-none mr-3">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
               <line x1="3" y1="12" x2="21" y2="12"></line>
               <line x1="3" y1="6" x2="21" y2="6"></line>
               <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
         </button>

         <div class="input-group search-bar">
          <div class="input-group-prepend">
            <span class="input-group-text bg-transparent border-0">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </span>
          </div>
          <input type="text" class="form-control bg-transparent border-0" placeholder="Search in Drive">
          <div class="input-group-append">
            <span class="input-group-text bg-transparent border-0">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="4" y1="21" x2="4" y2="14"></line>
                <line x1="4" y1="10" x2="4" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12" y2="3"></line>
                <line x1="20" y1="21" x2="20" y2="16"></line>
                <line x1="20" y1="12" x2="20" y2="3"></line>
                <line x1="1" y1="14" x2="7" y2="14"></line>
                <line x1="9" y1="8" x2="15" y2="8"></line>
                <line x1="17" y1="16" x2="23" y2="16"></line>
              </svg>
            </span>
          </div>
        </div>
      </div>

      <!-- Header with Toggle -->
      <div class="d-flex justify-content-between align-items-center mb-3">
         <h2 class="section-header mb-0">{% if viewMode == 'starred' %}Starred{% else %}Welcome to Drive{% endif %}</h2>
         <div class="btn-group" role="group" aria-label="Layout View">
            {% set listUrl = url('adminIndexList', { id: currentFolderId }, { query: { view: viewMode, layout: 'list' } }) %}
            {% set gridUrl = url('adminIndexList', { id: currentFolderId }, { query: { view: viewMode, layout: 'grid' } }) %}

            <a href="{{ listUrl }}" class="btn btn-sm btn-outline-secondary {% if layoutMode == 'list' %}active{% endif %}">

              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
              </svg>
            </a>
            <a href="{{ gridUrl }}" class="btn btn-sm btn-outline-secondary {% if layoutMode == 'grid' %}active{% endif %}">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
            </a>
         </div>
      </div>

      <!-- Folders Section -->
      {% if subFolders and subFolders.length > 0 %}
        <h6 class="section-header text-muted mb-3">Folders</h6>
        {% if layoutMode == 'list' %}
          <div class="table-responsive mb-4">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th scope="col" style="width: 40%;">Name</th>
                  <th scope="col">Owner</th>
                  <th scope="col">Last Modified</th>
                  <th scope="col" class="text-right">File Size</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody>
                {{ folderList(subFolders, viewMode, layoutMode) | safe }}
              </tbody>
            </table>
          </div>
        {% else %}
          {{ folderGrid(subFolders, viewMode, layoutMode) | safe }}
        {% endif %}
      {% endif %}

      <!-- Files Section -->
      {% if filesList and filesList.length > 0 %}
        <h6 class="section-header text-muted mb-3">Files</h6>
        {% if layoutMode == 'list' %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th scope="col" style="width: 40%;">Name</th>
                    <th scope="col">Owner</th>
                    <th scope="col">Last Modified</th>
                    <th scope="col" class="text-right">File Size</th>
                    <th scope="col"></th>
                  </tr>
                </thead>
                <tbody>
                  {{ fileList(filesList, starredFileIds, viewMode, layoutMode) | safe }}
                </tbody>
              </table>
            </div>
        {% else %}
           {{ fileGrid(filesList, starredFileIds, viewMode, layoutMode) | safe }}
        {% endif %}
      {% endif %}

      {% if (not subFolders or subFolders.length == 0) and (not filesList or filesList.length == 0) %}
        <div class="text-center mt-5">
            <div class="mb-3">
                 <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#e0e0e0" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                 </svg>
            </div>
            <p class="text-muted">This folder is empty</p>
        </div>
      {% endif %}

    </main>
</div>

  <!-- Rename Folder Modal -->
  <div class="modal fade" id="renameFolderModal" tabindex="-1" role="dialog" aria-labelledby="renameFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-bottom-0">
          <h5 class="modal-title" id="renameFolderModalLabel">Rename</h5>
        </div>
        <div class="modal-body">
          <form id="renameFolderForm">
            <input type="hidden" id="renameFolderId" name="folder_id">
            <div class="form-group">
              <input type="text" class="form-control" id="renameFolderName" name="name" placeholder="Folder name" required>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-text text-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary px-4" id="btnRenameFolderConfirm">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename File Modal -->
  <div class="modal fade" id="renameFileModal" tabindex="-1" role="dialog" aria-labelledby="renameFileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-bottom-0">
          <h5 class="modal-title" id="renameFileModalLabel">Rename File</h5>
        </div>
        <div class="modal-body">
          <form id="renameFileForm">
            <input type="hidden" id="renameFileId" name="file_id">
            <div class="form-group">
              <input type="text" class="form-control" id="renameFileName" name="name" placeholder="File name" required>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-text text-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary px-4" id="btnRenameFileConfirm">OK</button>
        </div>
      </div>
    </div>
  </div>

<!-- Delete Confirmation Modal (kept as is) -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to move this item to the trash?</p>
        <p class="text-danger">To confirm, type "<strong>Delete</strong>" in the box below.</p>
        <input type="text" id="deleteConfirmInput" class="form-control" placeholder="Type 'Delete' to confirm">
        <input type="hidden" id="deleteTargetUrl">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger" disabled>Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
